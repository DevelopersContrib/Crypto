<!DOCTYPE html>
<html>
<head>
  <title>Mytoken Contract</title>
</head>
<body class="container">
<div>
	<span>Create Account: </span><input type="text" placeholder="passphrase" id="new_passphrase"> <button id="new">Generate Account</button>
	<hr>
	<span>Enter Token Contract: </span><input id="tokencontractaddress" style="width: 400px;" type="text" value="" /> <button type="button" id="btnloadtoken">Load Token Contract</button><br>
	<span>Name: </span> <span class="tokenname"></span><br>
	<span>Address: </span> <span id="tokenaddress"></span><br>
	<span>Total Supply: </span> <span id="totalsupply"></span><br>
	<span>Mint Token: </span> <input id="tokenmint" type="text" value="" /> <button type="button" id="btntokenmint">Update</button><br>
	<br>
	<span>Sell Price: </span> <input id="sellprice" style="width:100px" type="text"/>
	<span>Buy Price: </span> <input id="buyprice" style="width:100px" type="text" /> <button type="button" id="btnupdateprices">Update</button><br>
	<hr>
	<span>Transfer Token: </span> <input id="tokenvalue" style="width: 50px;" type="text" value="1" /> from: <select id="accounts"></select> to: <input id="to" style="width:400px" type="text" value="" /> <button type="button" id="btnsendtoken">Send</button><br>
	
	<hr>
	<span>Wallet Address: </span> <input id="to2" style="width:400px" type="text" value="" /> <button type="button" id="btnbalanceof">Show Token Balance</button> <span id="balanceof"></span><hr>
	
	<span>Buyer: </span> <input id="buyer" style="width:400px" type="text" value="" /> Eth Amount: <input id="buyamount" style="width:100px" type="text" value="1" /> <button type="button" id="btnbuy">Buy</button>
	<hr>
	<span>Buyer: </span> <input id="buyer2" style="width:400px" type="text" value="" /> Token: <input id="buyamount2" style="width:100px" type="text" value="" /> <span id="totalamount"></span> <button type="button" id="btnbuy2">Buy</button>
	<hr>
	<span>Seller: </span> <input id="seller" style="width:400px" type="text" value="" /> Token: <input id="sellamount" style="width:100px" type="text" value="1" /> <button type="button" id="btnsell">Sell</button>
	<hr>
	<span>TxHash: </span> <input id="txhash" style="width:400px" type="text" value="" /> <button type="button" id="showtransaction">Show Transaction</button>
	<pre id="transaction"></pre>
</div>
<hr>
<h3 id="tokenname2">Methods</h3>
<ul id="func"></ul>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
<script type="text/javascript">
	var url = window.location.origin;
	
	$(document).ready(function() {
		console.log('ready');
		loadAccounts();
		
		loadContract($('#tokencontractaddress').val());
				
		$('#btnloadtoken').click(function(){
			loadContract($('#tokencontractaddress').val());
		});
		

		$('#buyamount2').on('keypress', function(e)
		{
			if (e.which != 8 && e.which != 0 && (e.which < 48 || e.which > 57)){
				e.stopImmediatePropagation();
				return false;
			}
		}).on('keyup change', function(e){
			$('#totalamount').html((totalEth())+' Eth');
		});
		
		$('#btnbuy2').click(function(){
			var account = $('#buyer2').val();
			buy(account,totalEth());
		});
				
		function totalEth(){
			var buyprice = $('#buyprice').val();
			var amount = $('#buyamount2').val();
			return (amount*buyprice);
		}

		$('#btnbalanceof').click(function(){
			var addr = $('#to2').val();
			if(addr!=""){
				getTokenBalance($('#tokencontractaddress').val(),addr);
			}
		});
		
		$("#new").click(function(){
			if($("#new_passphrase").val()!=''){
				$.get(url+'/createAccount?passphrase='+$("#new_passphrase").val(),function(data){
					alert($.parseJSON(data).address);
					setTimeout(function(){loadAccounts();},1000);
				});
			}
		}); 
		
		$('#btnupdateprices').click(function(){
			updatePrices();
		});
		
		
		$('#btnsendtoken').click(function(){
			var accnt1 = $('#accounts').val();
			var to = $('#to').val();
			var tokenvalue = $('#tokenvalue').val();
			var passphrase = prompt('Enter passphrase: ');
			if(accnt1!='' && to != '' && tokenvalue!= '' && !isNaN(tokenvalue) && passphrase!='' ){
				$.post(url+'/transfer',
				{
					tokenaddress:$('#tokencontractaddress').val(),
					account:accnt1,
					passphrase:passphrase,
					tokenvalue:tokenvalue,
					addressto:to
				}, function(data){
					var token = jQuery.parseJSON(data);
					console.log(token.txHash);
					alert(token.txHash);
					loadAccounts();
				});
			}else{
				alert('Error');
			}
		});
		
		$('#btntokenmint').click(function(){
			mint();
		});
		
		$('#btnbuy').click(function(){
			var amount = $('#buyamount').val();
			var account = $('#buyer').val();
			buy(account,amount);
		});
		
		$('#btnsell').click(function(){
			sell();
		});
		
		//getTransactionsByAccount($('#accounts').val());
		
		$('#showtransaction').click(function(){
			if($("#txhash").val()!=''){
				$.get(url+'/getTransaction?txhash='+$("#txhash").val(),function(data){
					var tx = $.parseJSON(data);
					$('#transaction').html(
						"   nonce           : " + tx.nonce + "<br>"
						+ "   blockHash       : " + tx.blockHash + "<br>"
						+ "   blockNumber     : " + tx.blockNumber + "<br>"
						+ "   transactionIndex: " + tx.transactionIndex + "<br>"
						+ "   from            : " + tx.from + "<br>" 
						+ "   to              : " + tx.to + "<br>"
						+ "   value           : " + tx.value + "<br>"
						+ "   gasPrice        : " + tx.gasPrice + "<br>"
						+ "   gas             : " + tx.gas + "<br>"
						+ "   input           : " + tx.input
					);
				});
			}
		});
	});
	
	function sell()
	{
		var amount = $('#sellamount').val();
		var account = $('#seller').val();
		var passphrase = prompt('Enter passphrase: ');
		if(account!='' && passphrase!='' ){
			try{
				$.post(url+'/sell',
				{
					token:$('#tokencontractaddress').val(),
					account:account,
					passphrase:passphrase,
					amount:amount,
				}, function(data){
					var token = jQuery.parseJSON(data);
					console.log(token.txHash);
					alert(token.txHash);
					loadAccounts();
				});
			} catch (err) {
				alert(err);
			}
		}
	}
	
	
	function buy(buyer,amount)
	{
		var account = buyer;
		var passphrase = prompt('Enter passphrase: ');
		if(account!='' && passphrase!='' ){
			try{
				$.post(url+'/buy',
				{
					token:$('#tokencontractaddress').val(),
					account:account,
					passphrase:passphrase,
					amount:amount,
				}, function(data){
					var token = jQuery.parseJSON(data);
					console.log(token.txHash);
					alert(token.txHash);
					loadAccounts();
				});
			} catch (err) {
				alert(err);
			}
		}
	}
	
	function mint()
	{
		var passphrase = prompt('Enter passphrase: ');
		var accnt1 = $('#accounts').val();
		var tokenvalue = $('#tokenmint').val();;
		
		if(accnt1!='' && tokenvalue!= '' && !isNaN(tokenvalue) && passphrase!='' ){
			$.post(url+'/mint',
			{
				tokenaddress:$('#tokencontractaddress').val(),
				account:accnt1,
				passphrase:passphrase,
				tokenvalue:tokenvalue,
			}, function(data){
				var token = jQuery.parseJSON(data);
				console.log(token.txHash);
				alert(token.txHash);
				loadAccounts();
			});
		}else{
			alert('Error');
		}
	}
	
	function updatePrices()
	{
		var sellprice = $('#sellprice').val();
		var buyprice = $('#buyprice').val();
		var accnt1 = $('#accounts').val();
		var token = $('#tokencontractaddress').val();
		var passphrase = prompt('Enter passphrase: ');
		
		if(accnt1!='' && passphrase!='' && token!='' && !isNaN(sellprice) && !isNaN(buyprice)){
			$.post(url+'/setPrices',
			{
				token:token,
				sellprice:sellprice,
				buyprice:buyprice,
				account:accnt1,
				passphrase:passphrase
			}, function(data){
				var token = jQuery.parseJSON(data);
				console.log(token.txHash);
				alert(token.txHash);
			});
		}
	}
	
	function getTokenBalance(token, account)
	{
		$.get(url+'/getBalanceOf?token='+token+'&account='+account,function(data){
			var token = jQuery.parseJSON(data);
			$('#balanceof').html(token.balance);
		});
	}
	
	function loadContract(address)
	{
		if(address=='' || address==undefined) return;
		$.get(url+'/getTokenName?address='+address,function(data){
			var token = jQuery.parseJSON(data);
			$('.tokenname').html(token.name);
			$('#tokenaddress').html(token.address);
		});	
		
		$.get(url+'/getSellPrice?address='+address,function(data){
			var token = jQuery.parseJSON(data);
			$('#sellprice').val(token.sellPrice);
		});	
		
		$.get(url+'/getBuyPrice?address='+address,function(data){
			var token = jQuery.parseJSON(data);
			$('#buyprice').val(token.buyPrice);
		});
		
		$.get(url+'/getTotalSupply?address='+address,function(data){
			var token = jQuery.parseJSON(data);
			$('#totalsupply').html(token.totalSupply);
		});	
	}
	
	function loadAccounts()
	{
		$.get(url+'/getAccounts',function(data){
			var accounts = jQuery.parseJSON(data);
			
			$('#accounts').html('');
			for(var x=0;x<accounts.length;x++){
				$.get(url+'/getAccntEthBalance?address='+accounts[x],function(data){
					var account = jQuery.parseJSON(data);
					$('#accounts').append('<option value="'+account.address+'">'+account.address+': eth('+account.balance+')'+'</option>');
				});				
			}
		});
	}
	/*
	
	
	
	function getTransactionsByAccount(myaccount, startBlockNumber, endBlockNumber) {
	  if (endBlockNumber == null) {
		endBlockNumber = web3.eth.blockNumber;
		console.log("Using endBlockNumber: " + endBlockNumber);
	  }
	  if (startBlockNumber == null) {
		startBlockNumber = endBlockNumber - 1000;
		console.log("Using startBlockNumber: " + startBlockNumber);
	  }
	  console.log("Searching for transactions to/from account \"" + myaccount + "\" within blocks "  + startBlockNumber + " and " + endBlockNumber);
	  for (var i = startBlockNumber; i <= endBlockNumber; i++) {
		if (i % 1000 == 0) {
		  console.log("Searching block " + i);
		}
		var block = web3.eth.getBlock(i, true);
		//console.log(block != null && block.transactions != null);
		if (block != null && block.transactions != null) {
		  block.transactions.forEach( function(e) {
			if (myaccount == "*" || myaccount == e.from || myaccount == e.to) {
			  console.log("  tx hash          : " + e.hash + "\n"
				+ "   nonce           : " + e.nonce + "\n"
				+ "   blockHash       : " + e.blockHash + "\n"
				+ "   blockNumber     : " + e.blockNumber + "\n"
				+ "   transactionIndex: " + e.transactionIndex + "\n"
				+ "   from            : " + e.from + "\n" 
				+ "   to              : " + e.to + "\n"
				+ "   value           : " + e.value + "\n"
				+ "   time            : " + block.timestamp + " " + new Date(block.timestamp * 1000).toGMTString() + "\n"
				+ "   gasPrice        : " + e.gasPrice + "\n"
				+ "   gas             : " + e.gas + "\n"
				+ "   input           : " + e.input);
			}
		  })
		}
	  }
	}*/
</script>
</body>
</html>